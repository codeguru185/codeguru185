WITH database_info AS (
    SELECT 
        database_name,
        CASE 
            WHEN database_owner = 'SYSTEM' THEN 'SHARED'
            WHEN database_name LIKE 'SNOWFLAKE%' THEN 'MANAGED DATABASE'
            ELSE 'REGULAR'
        END AS database_type,
        last_altered
    FROM snowflake.account_usage.databases
    WHERE deleted IS NULL
),
schema_info AS (
    SELECT 
        s.database_name,
        s.schema_name,
        s.is_transient,
        (SELECT COUNT(*) 
         FROM snowflake.account_usage.tables t 
         WHERE t.database_name = s.database_name 
         AND t.schema_name = s.schema_name) AS object_count,
        EXISTS (
            SELECT 1
            FROM snowflake.account_usage.row_access_policies rp
            WHERE rp.object_database = s.database_name
            AND rp.object_schema = s.schema_name
        ) AS has_row_access_policy
    FROM 
        snowflake.account_usage.schemas s
    WHERE 
        s.deleted IS NULL
        AND s.schema_name != 'PUBLIC'
)
SELECT 
    d.database_name,
    d.database_type,
    s.schema_name,
    CASE 
        WHEN s.is_transient = 'YES' THEN 'TRANSIENT SCHEMA'
        ELSE 'PERMANENT SCHEMA'
    END AS schema_type,
    CASE 
        WHEN s.object_count = 0 THEN 'EMPTY'
        ELSE 'NON-EMPTY'
    END AS schema_status,
    CASE 
        WHEN d.last_altered > CURRENT_DATE - 30 THEN 'RECENTLY MODIFIED'
        ELSE 'STABLE'
    END AS modification_status,
    CASE 
        WHEN d.database_type = 'SHARED' THEN 'EXTERNAL ACCESS'
        WHEN d.database_type = 'MANAGED DATABASE' THEN 'INTERNAL ACCESS - SYSTEM'
        ELSE 'INTERNAL ACCESS'
    END AS access_type,
    CASE 
        WHEN s.has_row_access_policy = TRUE THEN 'SENSITIVE DATA'
        ELSE 'REGULAR DATA'
    END AS data_sensitivity
FROM 
    database_info d
JOIN 
    schema_info s 
    ON d.database_name = s.database_name
ORDER BY 
    d.database_name, s.schema_name;
